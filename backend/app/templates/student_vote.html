<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vote</title>
  <style>
    body { font-family: system-ui, Arial; display:grid; place-items:center; min-height:100vh; }
    .card { padding: 24px; border: 1px solid #ddd; border-radius: 12px; width: 420px; text-align: center; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    button { flex: 1; padding: 12px 10px; border-radius: 10px; border: 1px solid #ccc; }
    .ok { color: #0a0; margin-top: 10px; }
    .warn { color: #a00; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Session {{ code }}</h1>
    <p>When the teacher calls a vote, tap one option below:</p>
    <div class="row">
      <button data-v="not_confused">Not confused</button>
      <button data-v="soso">So-so</button>
      <button data-v="confused">Confused</button>
    </div>
    <div id="msg"></div>
  </div>

  <script>
    const code = "{{ code }}";
    const msg = document.getElementById('msg');

    function getVoterId(){
        let id = localStorage.getItem('voter_id');
        if(!id){
            id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
                (c^crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
            localStorage.setItem('voter_id',id);
        }
        return id;
    }
    const voterId = getVoterId();
    for (const btn of document.querySelectorAll('button[data-v]')) {
      btn.addEventListener('click', async () => {
        const status = btn.getAttribute('data-v');
        const res = await fetch(`/api/session/${code}/vote`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ status, voter_id: voterId })
        });
        let txt = 'Error sending vote. Vote already recorded', cls = 'warn';
        if (res.ok) {
          const data = await res.json();
          if (data.ok) {
            txt = 'Vote recorded. Thanks!'; cls = 'ok';
            
          } else if (data.reason === 'already voted'){
            txt = 'Voting window is closed.';cls='warn';
          } else{
            txt = data.reason || 'Vote not accepted.';cls='warn';
          }
        } 
        msg.className = cls;
        msg.textContent = txt;   
      });
    }
  </script>
</body>
</html>
