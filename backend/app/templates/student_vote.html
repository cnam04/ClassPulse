<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student ‚Äî ClassPulse</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--fg:#111;--muted:#6b7280;--border:#e5e7eb;--card:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);background:#fafafa;min-height:100vh}
  .wrap{width:min(860px,94vw);margin:0 auto;padding:16px 16px 90px;text-align:center}
  .title{font-size:clamp(26px,4.5vw,44px);font-weight:800;margin:6px 0}
  .code{display:inline-block;margin-top:6px;font-size:clamp(16px,3vw,24px);background:#111;color:#fff;padding:6px 12px;border-radius:999px;letter-spacing:.12em}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:16px}
  .subtitle{color:var(--muted);font-size:clamp(15px,2vw,20px);margin:0 0 10px}
  .pill{display:inline-block;margin-bottom:12px;padding:6px 12px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-weight:700}
  .hint{margin:10px 0 6px;color:var(--muted);font-weight:700}
  .row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  button.vote{appearance:none;border:1px solid var(--border);border-radius:12px;padding:16px 10px;font-size:16px;font-weight:700;background:#f3f4f6;cursor:pointer}
  .count{font-size:28px;font-weight:800;display:block;margin-bottom:6px;opacity:.85}
  .red{background:#fee2e2;border-color:#ef4444}
  .yellow{background:#fef3c7;border-color:#d97706}
  .green{background:#dcfce7;border-color:#16a34a}
  #msg{margin-top:12px;min-height:1.2em;font-weight:600}
  .ok{color:#16a34a}.warn{color:#b91c1c}
  [hidden]{display:none!important}
  /* Broadcast question */
  .qwrap{ margin-top:14px; text-align:left; }
  .qcard{ border:1px solid var(--border); border-radius:12px; padding:14px; background:#fff }
  .qtitle{ font-weight:800; margin:0 0 6px; color:#111 }
  .qtext{ white-space:pre-wrap; color:#374151 }
  /* Student ask FAB */
  .fab{
    position:fixed; right:16px; bottom:16px;
    display:inline-flex; align-items:center; gap:10px;
    border:1px solid var(--border); background:#111; color:#fff;
    border-radius:999px; padding:12px 16px; font-weight:800; cursor:pointer;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
  }
  .fab svg{ width:20px; height:20px; }

  /* Poll (yes/no) */
  .poll{ margin-top:14px }
  .poll .box{ background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px }
  .poll .row2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
  .poll button{ appearance:none;border:1px solid var(--border);border-radius:12px;padding:16px 10px;font-size:16px;font-weight:800;background:#f3f4f6;cursor:pointer }
</style>
</head>
<body>
  <div class="wrap" id="state" data-code="{{ code }}">
    <div class="title">Session code:</div>
    <div class="code" id="scode">{{ code }}</div>

    <div class="card" role="region" aria-labelledby="how-feel">
      <!-- Broadcast question from teacher -->
      <div id="qwrap" class="qwrap" hidden>
        <div class="qcard">
          <div class="qtitle">Question from your teacher</div>
          <div id="qtext" class="qtext"></div>
        </div>
      </div>

      <!-- Before window -->
      <div id="pre" class="hint">Pay attention!</div>

      <!-- While window open -->
      <div id="win" class="pill" hidden>Window: checking‚Ä¶</div>
      <div id="how-feel" class="subtitle" hidden>How do you feel?</div>

      <!-- Buttons (window open only) -->
      <div id="controls" class="row" hidden>
        <button class="vote red"    data-v="confused"><span class="count">üòï</span>Confused</button>
        <button class="vote yellow" data-v="soso"><span class="count">üòê</span>So-so</button>
        <button class="vote green"  data-v="not_confused"><span class="count">üôÇ</span>Not confused</button>
      </div>

      <!-- Live poll (appears only when teacher starts one) -->
      <div id="poll" class="poll" hidden>
        <div class="box">
          <div id="pollTitle" class="subtitle" style="margin:0 0 8px">Quick poll</div>
          <div class="row2">
            <button id="btnYes">üëç Yes</button>
            <button id="btnNo">üëé No</button>
          </div>
          <div id="pollMsg" class="hint" style="margin-top:8px"></div>
        </div>
      </div>

      <div id="msg" aria-live="polite"></div>
    </div>
  </div>

  <!-- floating ask button (only visible when allowed) -->
  <button id="fab" class="fab" hidden>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-width="2" d="M9 9h.01M15 9h.01M8 13a4 4 0 0 0 8 0" />
      <circle cx="12" cy="12" r="9" stroke-width="2"/>
    </svg>
    Ask a question
  </button>

<script>
  // Session code
  function getSessionCode(){
    const root = document.getElementById('state');
    const fromAttr = root?.dataset.code || '';
    const fromTpl  = document.getElementById('scode')?.textContent || '';
    const fromQS   = new URLSearchParams(location.search).get('code') || '';
    return (fromAttr || fromTpl || fromQS || '').trim();
  }
  const code = getSessionCode();

  // Elements
  const msg=document.getElementById('msg');
  const pre=document.getElementById('pre');
  const win=document.getElementById('win');
  const howFeel=document.getElementById('how-feel');
  const controls=document.getElementById('controls');
  const buttons=[...controls.querySelectorAll('button.vote[data-v]')];
  const qwrap=document.getElementById('qwrap');
  const qtext=document.getElementById('qtext');
  const fab=document.getElementById('fab');
  // poll
  const pollBox=document.getElementById('poll');
  const pollTitle=document.getElementById('pollTitle');
  const pollMsg=document.getElementById('pollMsg');
  const btnYes=document.getElementById('btnYes');
  const btnNo=document.getElementById('btnNo');

  const ERROR_MS=2000, OK_MS=3000;

  function showMsg(kind,text,ms=0){
    clearTimeout(showMsg._t);
    msg.className=kind||''; msg.textContent=text||'';
    if(ms>0) showMsg._t=setTimeout(()=>{ msg.className=''; msg.textContent=''; }, ms);
  }

  // Stable voter id + per-session flags
  function getVoterId(){
    let id=localStorage.getItem('voter_id');
    if(!id){
      id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
        (c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)
      );
      localStorage.setItem('voter_id',id);
    }
    return id;
  }
  const voterId=getVoterId();
  const votedKey=`voted_${code}`;
  const hasVoted=()=>localStorage.getItem(votedKey)==='1';
  const markVoted=()=>localStorage.setItem(votedKey,'1');
  
  let windowOpen=false;
  let lastOpen = false;
  let lastWindowId=0;
  let currentPollId = 0;
  let currentPollKey = '';

function setPollKey(id){
  currentPollId = id|0;
  currentPollKey = `polled_${code}_${currentPollId}`;
}
function hasPolled(){ return localStorage.getItem(currentPollKey) === '1'; }
function markPolled(){ localStorage.setItem(currentPollKey, '1'); }

  function updateVoteUI(){
    if(windowOpen){
      pre.hidden = true;
      win.hidden = false;
      howFeel.hidden = false;
      controls.hidden = false;
      const disable = hasVoted();
      buttons.forEach(b=>b.disabled = disable);
    }else{
      pre.hidden = false;
      win.hidden = true;
      howFeel.hidden = true;
      controls.hidden = true;
      msg.className = '';
      msg.textContent = '';
    }
  }

    // Stats poll (vote window)
    async function fetchStats() {
    try {
        const res = await fetch(
        `/api/session/${encodeURIComponent(code)}/stats`,
        { cache: 'no-store', headers: { 'Accept': 'application/json' } }
        );
        if (!res.ok) throw 0;
        const d = await res.json();

        const open   = !!d.window_active;
        const remain = d.window_seconds_remaining ?? 0;

        // NEW WINDOW started (even if a window was already open)
        if (typeof d.window_id === 'number' && d.window_id !== lastWindowId) {
        localStorage.removeItem(votedKey);   // allow voting again this round
        msg.textContent = '';
        msg.className   = '';
        lastWindowId    = d.window_id;
        }

        // optional: keep edge detection; harmless
        lastOpen   = open;
        windowOpen = open;

        if (windowOpen) win.textContent = `Window: ${remain}s left`;

        // Their project calls updateVoteUI(); if it exists, use it; otherwise use your updateUI()
        if (typeof updateVoteUI === 'function') {
        updateVoteUI();
        } else {
        updateUI();
        }
    } catch {}
    }

  // Broadcast teacher question poll
  async function fetchQuestion(){
    try{
      const res=await fetch(`/api/session/${encodeURIComponent(code)}/question`, { headers:{'Accept':'application/json'} });
      if(!res.ok){ qwrap.hidden=true; qtext.textContent=''; return; }
      const d=await res.json();
      const t = (d?.text ?? d?.question ?? d?.data?.text ?? '').toString().trim();
      if(t){ qtext.textContent=t; qwrap.hidden=false; }
      else { qwrap.hidden=true; qtext.textContent=''; }
    }catch{}
  }

  // Permission poll for showing the ask button
  async function fetchAskPermission(){
    try{
      const res=await fetch(`/api/session/${encodeURIComponent(code)}/qperm`, { headers:{'Accept':'application/json'} });
      if(!res.ok){ fab.hidden = true; return; }
      const d=await res.json();
      fab.hidden = !Boolean(d?.allow);
    }catch{ fab.hidden = true; }
  }

  // Send vote (confusion)
  async function sendVote(status){
    const res=await fetch(`/api/session/${encodeURIComponent(code)}/vote`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({status, voter_id:voterId})
    });
    if(!res.ok) return {ok:false, reason:'Network error'};
    return res.json();
  }

  buttons.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!windowOpen){ showMsg('warn','Voting not open yet.',ERROR_MS); return; }
      if(hasVoted()){  showMsg('warn','Vote already recorded.',ERROR_MS); return; }
      buttons.forEach(b=>b.disabled=true);
      showMsg('', 'Sending‚Ä¶');
      try{
        const data=await sendVote(btn.getAttribute('data-v'));
        if(data.ok){ markVoted(); showMsg('ok','Vote recorded.',OK_MS); }
        else if(data.reason==='already voted'){ markVoted(); showMsg('warn','Vote already recorded.',ERROR_MS); }
        else if(data.reason==='window closed'){ showMsg('warn','Voting not open yet.',ERROR_MS); }
        else{ showMsg('warn', data.reason||'Vote not accepted.', ERROR_MS); }
      }catch{
        showMsg('warn','Network error',ERROR_MS);
      }finally{
        updateVoteUI();
      }
    });
  });

  // Student ask flow
  fab.addEventListener('click', async ()=>{
    const text = (prompt('Ask your question (anonymous to teacher):') || '').trim();
    if(!text) return;
    try{
      const res=await fetch(`/api/session/${encodeURIComponent(code)}/student_question`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, voter_id: voterId })
      });
      if(res.ok){ showMsg('ok','Question sent!', OK_MS); }
      else{ showMsg('warn','Could not send question.', ERROR_MS); }
    }catch{
      showMsg('warn','Network error.', ERROR_MS);
    }
  });

  // POLL ‚Äî show/hide and vote
  async function fetchPoll(){
    try{
        const r = await fetch(`/api/session/${encodeURIComponent(code)}/poll`, {
        headers:{'Accept':'application/json'}, cache:'no-store'
        });
        if(!r.ok){ pollBox.hidden = true; return; }
        const p = await r.json();
        const active = !!p.active;

        // ‚¨áÔ∏è if poll_id changed, switch the localStorage key and re-enable buttons
        if (active && typeof p.poll_id === 'number' && p.poll_id !== currentPollId){
        setPollKey(p.poll_id);
        btnYes.disabled = btnNo.disabled = hasPolled();
        pollMsg.textContent = hasPolled() ? 'Thanks‚Äîyour vote was recorded.' : '';
        }

        pollBox.hidden = !active;
        if(active){
        pollTitle.textContent = p?.question ? p.question : 'Quick poll';
        // keep buttons state in sync in case we landed mid-poll
        btnYes.disabled = btnNo.disabled = hasPolled();
        if (hasPolled()) pollMsg.textContent = 'Thanks‚Äîyour vote was recorded.';
        } else {
        // no active poll -> clear UI but keep past keys (history is fine)
        pollMsg.textContent = '';
        }
    }catch{ pollBox.hidden = true; }
    }
    async function sendPollVote(choice){
    try{
        const r = await fetch(`/api/session/${encodeURIComponent(code)}/poll/vote`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ choice, voter_id: voterId })
        });
        if(r.ok){
        markPolled();
        btnYes.disabled = btnNo.disabled = true;
        pollMsg.textContent = 'Thanks‚Äîyour vote was recorded.';
        }else{
        pollMsg.textContent = 'Could not send vote.';
        }
    }catch{
        pollMsg.textContent = 'Network error.';
    }
    }
    btnYes.addEventListener('click', ()=> sendPollVote('yes'));
    btnNo .addEventListener('click', ()=> sendPollVote('no'));


  // start polling
  fetchStats(); fetchQuestion(); fetchAskPermission(); fetchPoll();
  setInterval(fetchStats, 1000);
  setInterval(fetchQuestion, 1000);
  setInterval(fetchAskPermission, 1000);
  setInterval(fetchPoll, 800); // a tad faster for poll UX
</script>
</body>
</html>
