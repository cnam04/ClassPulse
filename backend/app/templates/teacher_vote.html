<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher — Call a Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --fg:#111; --muted:#666; --border:#e5e7eb; --btn:#111; --btnfg:#fff;
      --red:#dc2626; --red-bg:#fee2e2;
      --yellow:#ca8a04; --yellow-bg:#fef3c7;
      --green:#16a34a; --green-bg:#dcfce7;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --dur:.28s;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center; background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; color:var(--fg);
    }
    .wrap{ width:min(960px,94vw); }
    h1{ margin:0 0 14px; text-align:center; font-size:2rem; font-weight:800 }
    h1::after{ content:""; display:block; width:56px; height:4px; border-radius:3px; background:var(--fg); margin:10px auto 0 }

    .row{ display:grid; grid-template-columns: 1fr auto; gap:14px; align-items:start; margin-top:10px }
    @media (max-width:820px){ .row{ grid-template-columns:1fr } }

    .stack{ display:grid; gap:10px }
    button{
      appearance:none; padding:14px 16px; border-radius:14px; border:1px solid var(--btn);
      background:var(--btn); color:var(--btnfg); font-weight:800; cursor:pointer; box-shadow:var(--shadow)
    }
    .pill{
      min-width:190px; text-align:center; padding:10px 14px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); font-weight:700; background:#fff
    }
    .meta{ margin:16px 0 10px; color:var(--muted); font-size:1.05rem; text-align:center }

    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px }
    .stat{ border:1px solid var(--border); border-radius:14px; padding:16px; text-align:center; background:#fff }
    .n{ font-size:2rem; font-weight:800; letter-spacing:.02em }
    .label{ color:var(--muted); margin-top:4px; font-weight:700 }
    .cf{ border-color:var(--red); background:var(--red-bg) }
    .ss{ border-color:var(--yellow); background:var(--yellow-bg) }
    .nc{ border-color:var(--green); background:var(--green-bg) }

    /* Student questions panel */
    .panel{
      border:1px solid var(--border); border-radius:14px; background:#fff; padding:14px;
    }
    .panel h2{ margin:0 0 8px; font-size:1.05rem }
    .row2{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center }
    .switch{
      display:inline-flex; align-items:center; gap:8px; user-select:none; cursor:pointer; color:#111; font-weight:700;
    }
    .switch input{ appearance:none; width:38px; height:22px; border-radius:999px; position:relative; background:#e5e7eb; outline:none; transition:.2s }
    .switch input:checked{ background:#111 }
    .switch input::after{
      content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:#fff; transition:.2s
    }
    .switch input:checked::after{ transform:translateX(16px) }

    .qcount{ color:var(--muted); font-weight:700 }
    .qlist{ margin-top:10px; display:grid; gap:8px; max-height:220px; overflow:auto }
    .qitem{ border:1px solid var(--border); border-radius:12px; padding:10px; }
    .qmeta{ color:var(--muted); font-size:.88rem; margin-top:6px }
    .qactions{ display:flex; gap:8px; margin-top:8px }
    .btn-lite{
      background:#fff; color:#111; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer;
    }

    /* === NEW: Simple bar chart === */
    .chart{
      margin-top:14px; border:1px solid var(--border); border-radius:14px; background:#fff; padding:14px;
    }
    .chart h2{ margin:0 0 8px; font-size:1.05rem }
    .bars{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; align-items:end; height:180px; padding:6px 4px 0;
    }
    .bar{
      position:relative; border-radius:10px 10px 6px 6px; min-height:4px;
      display:flex; align-items:flex-end; justify-content:center; transition:height .25s ease;
    }
    .bar .val{
      position:absolute; top:-22px; font-weight:800; font-size:14px; color:#111;
    }
    .bar.red{    background:var(--red);    border:1px solid var(--red); }
    .bar.yellow{ background:var(--yellow); border:1px solid var(--yellow); }
    .bar.green{  background:var(--green);  border:1px solid var(--green); }
    .xlabel{
      text-align:center; margin-top:6px; font-weight:700; color:#555; font-size:14px;
    }
  </style>
</head>
<body>
  <main id="state" class="wrap" data-code="{{ code }}">
    <h1>Session code: <span id="scode">{{ code }}</span></h1>

    <section class="row">
      <div class="stack">
        <form id="start" onsubmit="return false;">
          <button type="submit">Call 60-second Vote</button>
        </form>

        <!-- Teacher asks broadcast question -->
        <div class="panel" aria-labelledby="qlab">
          <h2 id="qlab">Ask a question to all students</h2>
          <div class="row2">
            <input id="qinput" type="text" placeholder="Type your question…" style="border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:16px" />
            <button id="qsend" type="button" aria-label="Send question">Send</button>
          </div>
          <div style="margin-top:8px">
            <button id="qclear" class="btn-lite" type="button">Clear broadcast question</button>
          </div>
        </div>

        <!-- Student Questions -->
        <div class="panel">
          <h2>Student Questions</h2>
          <label class="switch">
            <input id="allow" type="checkbox" />
            <span>Allow student questions</span>
          </label>
          <div class="qcount" id="qcount">No questions yet</div>
          <div class="qlist" id="qlist"></div>
        </div>

        <!-- === NEW: Live Bar Chart === -->
        <div class="chart" aria-labelledby="chart-title">
          <h2 id="chart-title">Live Vote Results</h2>
          <div class="bars">
            <div class="bar red"    id="bar-cf" style="height:4px"><span class="val" id="val-cf">0</span></div>
            <div class="bar yellow" id="bar-ss" style="height:4px"><span class="val" id="val-ss">0</span></div>
            <div class="bar green"  id="bar-nc" style="height:4px"><span class="val" id="val-nc">0</span></div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap:14px; margin-top:2px">
            <div class="xlabel">Confused</div>
            <div class="xlabel">So-so</div>
            <div class="xlabel">Not Confused</div>
          </div>
        </div>
      </div>

      <div>
        <div id="timer" class="pill" aria-live="polite">Window: closed</div>

        <p class="meta">Participants: <strong id="pcount">0</strong></p>
        <section class="grid">
          <div class="stat cf">
            <div id="cf" class="n">0</div><div class="label">Confused</div>
          </div>
          <div class="stat ss">
            <div id="ss" class="n">0</div><div class="label">So-so</div>
          </div>
          <div class="stat nc">
            <div id="nc" class="n">0</div><div class="label">Not Confused</div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    // Session code utility
    function getSessionCode(){
      const el = document.getElementById('state');
      const fromAttr = el?.dataset.code || '';
      const fromTpl = document.getElementById('scode')?.textContent || '';
      const fromQS = new URLSearchParams(location.search).get('code') || '';
      return (fromAttr || fromTpl || fromQS || '').trim();
    }
    const code = getSessionCode();

    // Elements
    const els = {
      start:  document.getElementById('start'),
      timer:  document.getElementById('timer'),
      pcount: document.getElementById('pcount'),
      nc:     document.getElementById('nc'),
      ss:     document.getElementById('ss'),
      cf:     document.getElementById('cf'),
      qinput: document.getElementById('qinput'),
      qsend:  document.getElementById('qsend'),
      qclear: document.getElementById('qclear'),
      allow:  document.getElementById('allow'),
      qcount: document.getElementById('qcount'),
      qlist:  document.getElementById('qlist'),
      // chart bits
      barCF:  document.getElementById('bar-cf'),
      barSS:  document.getElementById('bar-ss'),
      barNC:  document.getElementById('bar-nc'),
      valCF:  document.getElementById('val-cf'),
      valSS:  document.getElementById('val-ss'),
      valNC:  document.getElementById('val-nc'),
    };

    // Vote window
    els.start.addEventListener('submit', async () => {
      try{ await fetch(`/api/session/${encodeURIComponent(code)}/start_window`, { method:'POST' }); }catch(_){}
      tickStats();
    });

    // Broadcast teacher question
    els.qsend.addEventListener('click', async () => {
      const text = (els.qinput.value || '').trim();
      if(!text) return;
      try{
        await fetch(`/api/session/${encodeURIComponent(code)}/question`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text, question:text })
        });
        els.qinput.value='';
      }catch(_){}
    });
    els.qclear.addEventListener('click', async () => {
      try{
        await fetch(`/api/session/${encodeURIComponent(code)}/question`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text:'' })
        });
      }catch(_){}
    });

    // Allow student questions toggle
    async function setAllow(val){
      try{
        await fetch(`/api/session/${encodeURIComponent(code)}/qperm`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ allow: !!val })
        });
      }catch(_){}
    }
    els.allow.addEventListener('change', e => setAllow(e.target.checked));

    // Poll permission + list of student questions
    async function tickPermAndQuestions(){
      try{
        const r1 = await fetch(`/api/session/${encodeURIComponent(code)}/qperm`, { headers:{'Accept':'application/json'} });
        if(r1.ok){
          const p = await r1.json();
          els.allow.checked = !!(p?.allow);
        }
      }catch(_){}
      try{
        const r2 = await fetch(`/api/session/${encodeURIComponent(code)}/student_questions`, { headers:{'Accept':'application/json'} });
        if(!r2.ok) return;
        const arr = await r2.json();
        els.qcount.textContent = (arr && arr.length) ? `${arr.length} question${arr.length>1?'s':''}` : 'No questions yet';
        renderQuestions(arr||[]);
      }catch(_){}
    }

    function renderQuestions(items){
      const root = els.qlist;
      root.innerHTML = '';
      items.forEach(q=>{
        const div = document.createElement('div');
        div.className = 'qitem';
        const when = q?.ts ? new Date(q.ts*1000).toLocaleTimeString() : '';
        div.innerHTML = `
          <div>${(q?.text||'').toString()}</div>
          <div class="qmeta">${when}</div>
          <div class="qactions">
            <button class="btn-lite" data-a="broadcast">Broadcast</button>
            <button class="btn-lite" data-a="remove">Remove</button>
          </div>`;
        div.querySelector('[data-a="broadcast"]').addEventListener('click', async ()=>{
          try{
            await fetch(`/api/session/${encodeURIComponent(code)}/question`,{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ text: q.text })
            });
          }catch(_){}
        });
        div.querySelector('[data-a="remove"]').addEventListener('click', async ()=>{
          try{
            await fetch(`/api/session/${encodeURIComponent(code)}/student_questions/${encodeURIComponent(q.id)}`, { method:'DELETE' });
            tickPermAndQuestions();
          }catch(_){}
        });
        root.appendChild(div);
      });
    }

    // === NEW: render bar chart ===
    function renderChart(cConfused, cSoso, cNC){
      const a = Number(cConfused||0);
      const b = Number(cSoso||0);
      const c = Number(cNC||0);
      const max = Math.max(1, a, b, c);      // avoid /0; also keeps a tiny baseline
      const H = 160;                          // px max height inside 180px area (some headroom)

      els.valCF.textContent = a;
      els.valSS.textContent = b;
      els.valNC.textContent = c;

      // map counts to heights; ensure small nonzero shows a visible bar (min 4px if >0)
      const h = (v)=> v===0 ? 4 : Math.max(8, Math.round((v/max)*H));

      els.barCF.style.height = h(a) + 'px';
      els.barSS.style.height = h(b) + 'px';
      els.barNC.style.height = h(c) + 'px';
    }

    // Stats polling
    async function tickStats(){
      try{
        const res = await fetch(`/api/session/${encodeURIComponent(code)}/stats`, { headers:{'Accept':'application/json'} });
        if(!res.ok) return;
        const d = await res.json();
        // update counters
        els.pcount.textContent = d.participants ?? 0;
        els.nc.textContent = d.not_confused ?? 0;
        els.ss.textContent = d.soso ?? 0;
        els.cf.textContent = d.confused ?? 0;
        const open   = !!d.window_active;
        const remain = d.window_seconds_remaining ?? 0;
        els.timer.textContent = open ? `Window: ${remain}s left` : 'Window: closed';

        // update chart
        renderChart(d.confused ?? 0, d.soso ?? 0, d.not_confused ?? 0);
      }catch(_){}
    }

    // start polling
    tickStats(); tickPermAndQuestions();
    setInterval(tickStats, 1000);
    setInterval(tickPermAndQuestions, 1000);
  </script>
</body>
</html>
