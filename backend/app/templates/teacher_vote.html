<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher â€” Call a Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --fg:#111; --muted:#666; --border:#e5e7eb; --btn:#111; --btnfg:#fff;
      --dur:1.0s; --d1:.12s; --d2:.28s; --d3:.44s;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; color:var(--fg);
      background:#fff;
    }
    .wrap{ width:min(820px, 94vw); }

    /* Title */
    h1{
      margin:0 0 20px; text-align:center; font-size:2.1rem; font-weight:800;
    }
    h1::after{
      content:""; display:block; width:56px; height:4px; border-radius:3px;
      background:var(--fg); margin:10px auto 0;
    }

    /* Controls row */
    .row{
      display:grid; grid-template-columns: 1fr auto; gap:14px;
      align-items:center; margin-top:10px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    button{
      padding:16px 18px; width:100%;
      border-radius:14px; border:1px solid var(--btn);
      background:var(--btn); color:var(--btnfg); font-weight:700; cursor:pointer;
    }
    button:hover{ filter:brightness(1.03) }
    button:active{ transform:translateY(1px) }
    .pill{
      min-width:190px; text-align:center;
      padding:10px 14px; border:1px solid var(--border); border-radius:999px; color:var(--muted);
    }

    /* Stats */
    .meta{ margin:20px 0 8px; color:var(--muted); font-size:1.05rem; text-align:center; }
    .grid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;
    }
    .stat{
      border:1px solid var(--border); border-radius:14px; padding:16px; text-align:center;
      background:#fff;
    }
    .n{ font-size:2rem; font-weight:800; letter-spacing:.02em }
    .label{ color:var(--muted); margin-top:4px; font-weight:600 }

    /* Animations */
    @keyframes floatFade{
      0%{opacity:0; transform:translateY(12px) scale(.98)}
      60%{opacity:1; transform:translateY(0) scale(1)}
      100%{opacity:1; transform:translateY(0) scale(1)}
    }
    .a-title{ opacity:0; animation:floatFade var(--dur) cubic-bezier(.22,.61,.36,1) var(--d1) both }
    .a-row  { opacity:0; animation:floatFade var(--dur) cubic-bezier(.22,.61,.36,1) var(--d2) both }
    .a-stats{ opacity:0; animation:floatFade var(--dur) cubic-bezier(.22,.61,.36,1) var(--d3) both }
    @media (prefers-reduced-motion:reduce){
      .a-title,.a-row,.a-stats{ animation:none!important; opacity:1 }
    }
  </style>
</head>
<body>
  <!-- store code for JS without Jinja inside the script -->
  <main id="state" class="wrap" data-code="{{ code }}">
    <h1 class="a-title">Session code: {{ code }}</h1>

    <section class="row a-row">
      <form id="start" onsubmit="return false;">
        <button type="submit">Call 60-second Vote</button>
      </form>
      <div id="timer" class="pill">Window: closed</div>
    </section>

    <p class="meta a-stats">Participants: <strong id="pcount">0</strong></p>

    <section class="grid a-stats">
      <div class="stat">
        <div id="cf" class="n">0</div>
        <div class="label">Confused</div>
      </div>
      <div class="stat">
        <div id="ss" class="n">0</div>
        <div class="label">So-so</div>
      </div>
      <div class="stat">
        <div id="nc" class="n">0</div>
        <div class="label">Not Confused</div>
      </div>
    </section>
  </main>

  <script>
    const code = document.getElementById('state')?.dataset.code || '';
    const els = {
      start: document.getElementById('start'),
      timer: document.getElementById('timer'),
      pcount: document.getElementById('pcount'),
      nc: document.getElementById('nc'),
      ss: document.getElementById('ss'),
      cf: document.getElementById('cf'),
    };

    els.start.addEventListener('submit', async () => {
      try{
        await fetch(`/api/session/${code}/start_window`, { method: 'POST' });
      }catch(_){}
      tick(); // refresh immediately
    });

    async function tick(){
      try{
        const res = await fetch(`/api/session/${code}/stats`);
        if(!res.ok) return;
        const d = await res.json();

        els.pcount.textContent = d.participants ?? 0;
        els.nc.textContent = d.not_confused ?? 0;
        els.ss.textContent = d.soso ?? 0;
        els.cf.textContent = d.confused ?? 0;

        const open = !!d.window_active;
        const remain = d.window_seconds_remaining ?? 0;
        els.timer.textContent = open ? `Window: ${remain}s left` : 'Window: closed';
      }catch(_){}
    }

    setInterval(tick, 1000);
    tick();
  </script>
</body>
</html>
