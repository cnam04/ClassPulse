<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Join Session — ClassPulse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --fg:#111; --bg:#fff; --muted:#6b7280; --border:#e5e7eb;
      --btn:#111; --btnfg:#fff; --danger:#b91c1c;
      --radius:20px; --gap:clamp(14px, 4vw, 28px);
    }
    @media (prefers-color-scheme:dark){
      :root{
        --fg:#f6f7f8; --bg:#0b0b0c; --muted:#a1a1aa; --border:#26272b;
        --btn:#f6f7f8; --btnfg:#0b0b0c;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .wrap{
      min-height:100dvh;
      padding:
        calc(env(safe-area-inset-top) + var(--gap))
        calc(env(safe-area-inset-right) + var(--gap))
        calc(env(safe-area-inset-bottom) + var(--gap))
        calc(env(safe-area-inset-left) + var(--gap));
      display:grid;
      align-content:center;
      justify-items:stretch;
      gap:clamp(10px,3vw,16px);
    }

    h1{
      margin:0;
      font-weight:900; letter-spacing:.2px;
      font-size:clamp(28px, 9vw, 44px);
      text-align:center;
    }

    form{display:grid; gap:clamp(12px,3.5vw,20px)}

    .field{display:grid; gap:10px}
    label{
      font-weight:700; color:var(--muted);
      font-size:clamp(16px, 4.5vw, 18px);
      text-align:center;
    }

    input{
      width:100%;
      height:64px;
      border:1px solid var(--border);
      border-radius:16px;
      background:transparent; color:var(--fg);
      font-size:clamp(22px, 7.5vw, 28px);
      font-weight:800;
      letter-spacing:.28em;
      text-align:center;
      text-transform:uppercase;
      caret-color:var(--fg);
      padding:0 18px;
    }
    input::placeholder{color:var(--muted)}
    input:focus{outline:3px solid rgba(99,102,241,.25)}

    button{
      width:100%;
      height:64px;
      border:1px solid var(--btn);
      border-radius:16px;
      background:var(--btn); color:var(--btnfg);
      font-weight:900;
      font-size:clamp(18px, 6vw, 20px);
      letter-spacing:.02em; cursor:pointer;
    }
    button[disabled]{opacity:.5; cursor:not-allowed}

    @media (hover:hover){
      button:hover:not([disabled]){filter:brightness(1.05)}
      button:active:not([disabled]){transform:translateY(1px)}
    }

    .err{
      color:var(--danger); font-weight:800; text-align:center;
      font-size:clamp(16px, 4.5vw, 18px);
      margin-top:6px;
    }

    @media (min-width:820px){
      .wrap{place-items:center}
      .panel{
        width:min(720px, 88vw);
        border:1px solid var(--border);
        border-radius:var(--radius);
        padding:clamp(20px, 3vw, 40px);
        background:rgba(255,255,255,.7);
        backdrop-filter:saturate(1.2) blur(2px);
      }
      @media (prefers-color-scheme:dark){
        .panel{ background:rgba(16,16,18,.5) }
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel">
      <h1>Join a Session</h1>

      <form method="post" action="/student/join" novalidate>
        <div class="field">
          <label for="code">Enter 8-letter code</label>
          <input
            id="code"
            name="code"
            placeholder="ABCDEFGH"
            inputmode="text"
            autocapitalize="characters"
            autocorrect="off"
            spellcheck="false"
            maxlength="8"
            pattern="[A-Z]{8}"
            title="Enter 8 capital letters (A–Z)"
            aria-invalid="{{ 'true' if error else 'false' }}"
            required
          />
        </div>
        <button id="joinBtn" type="submit" disabled>Join</button>
      </form>

      {% if error %}
        <div class="err" role="alert" aria-live="polite">{{ error }}</div>
      {% endif %}
    </section>
  </main>

  <script>
    // Helpers
    const qs = new URLSearchParams(location.search);
    const codeInput = document.getElementById('code');
    const joinBtn   = document.getElementById('joinBtn');
    const form      = document.querySelector('form');

    // Prefill from query (?code=XXXXXXXX) or last success
    const fromQS   = (qs.get('code') || '').toUpperCase();
    const fromLast = localStorage.getItem('last_session_code') || '';
    if (fromQS.match(/^[A-Z]{8}$/)) {
      codeInput.value = fromQS;
    } else if (fromLast.match(/^[A-Z]{8}$/)) {
      codeInput.value = fromLast;
    }

    // Live enforce uppercase-only A–Z and enable button at 8 chars
    function sanitize(v){
      return v.toUpperCase().replace(/[^A-Z]/g,'').slice(0,8);
    }
    function updateState(){
      const v = sanitize(codeInput.value);
      if (v !== codeInput.value) codeInput.value = v;
      joinBtn.disabled = v.length !== 8;
    }
    codeInput.addEventListener('input', updateState);
    codeInput.addEventListener('focus', () => {
      const v = codeInput.value; codeInput.setSelectionRange(v.length, v.length);
    });
    updateState();

    // On submit, lock to 8 letters and remember it (so next load can suggest)
    form.addEventListener('submit', () => {
      const v = sanitize(codeInput.value);
      codeInput.value = v;
      if (v.length === 8) {
        try { localStorage.setItem('last_session_code', v); } catch {}
      }
    });

    // Optional: auto-submit when 8 chars reached
    // setTimeout(() => {
    //   const obs = new MutationObserver(() => {
    //     if (!joinBtn.disabled && document.activeElement === codeInput) form.requestSubmit();
    //   });
    //   obs.observe(joinBtn, { attributes: true, attributeFilter: ['disabled'] });
    // }, 0);
  </script>
</body>
</html>
